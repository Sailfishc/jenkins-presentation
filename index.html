<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=1024, user-scalable=no">

  <title>Your deck.js Presentation</title>

  <!-- Required stylesheet -->
  <link rel="stylesheet" media="screen" href="core/deck.core.css">

  <!-- Extension CSS files go here. Remove or add as needed. -->
  <link rel="stylesheet" media="screen" href="extensions/goto/deck.goto.css">
  <link rel="stylesheet" media="screen" href="extensions/menu/deck.menu.css">
  <link rel="stylesheet" media="screen" href="extensions/navigation/deck.navigation.css">
  <link rel="stylesheet" media="screen" href="extensions/status/deck.status.css">
  <link rel="stylesheet" media="screen" href="extensions/scale/deck.scale.css">

  <!-- Style theme. More available in /themes/style/ or create your own. -->
  <link rel="stylesheet" media="screen" href="themes/style/web-2.0.css">

  <!-- Transition theme. More available in /themes/transition/ or create your own. -->
  <link rel="stylesheet" media="screen" href="themes/transition/horizontal-slide.css">

  <!-- Basic black and white print styles -->
  <link rel="stylesheet" media="print" href="core/print.css">

  <!-- Required Modernizr file -->
  <script src="modernizr.custom.js"></script>
</head>
<body>
<div class="deck-container">

<!-- Begin slides. Just make elements with a class of slide. -->

<section class="slide">
  <h1>使用 Jenkins 优化团队开发流程</h1>
</section>

<section class="slide">
  <h2>个人简介</h2>

  <p>刘志鹏 / hustlzp</p>

  <p>华中科技大学光电学院，2015年6月毕业。</p>

  <p>博客: hustlzp.com</p>

  <p>GitHub用户名: hustlzp</p>

</section>

<section class="slide">
  <h2>概要</h2>
  <ul>
    <li>真实的需求</li>
    <li>Jenkins简介</li>
    <li>安装和启动</li>
    <li>自动化测试、代码质量检测、发布</li>
    <li>Jenkins配置文件的备份、变更记录</li>
    <li>小结</li>
  </ul>
</section>

<section class='slide'>
  <h2>真实的需求</h2>

  <p>曾经参与一个学生创业团队，主要使用Python做Web开发。</p>

  <ul>
    <li>A新建了一个特性分支，写完了功能代码</li>
    <li>A忘记了执行单元测试，就将此分支合并到master</li>
    <li>A将代码部署到生产服务器</li>
    <li>网站出现了bug，严重影响了用户体验</li>
  </ul>

  <p><strong>解决方案</strong>：将测试/部署等 <strong>「容易遗漏的、重复性的、枯燥的」</strong> 过程，交给机器自动完成。</p>
  <ul>
    <li>减少风险，缩短 <strong>开发-测试-交付</strong> 的周期</li>
    <li>增强项目的可见性，增强团队对开发产品的信心</li>
  </ul>
</section>

<section class='slide'>
  <h2>Jenkins简介</h2>

  <img style="margin-left: 0" src="http://jenkins-ci.org/sites/default/files/jenkins_logo.png">

  <p>市场占有率最高（70%）的持续集成工具。</p>

  <ul>
    <li>安装简单</li>
    <li>配置简单</li>
    <li>极其丰富的插件</li>
    <li>非常高的开发频率（GitHub项目地址: https://github.com/jenkinsci/jenkins）</li>
  </ul>
</section>

<section class="slide">
  <h2>安装和启动</h2>

  <p>针对Windows、Ubuntu、CentOS等数10种操作系统都提供了安装包。</p>

  <h3>举例：CentOS 6.5</h3>

    <pre>yum install jenkins
service jenkins start</pre>

  <h3>使用Docker安装</h3>

  <pre>docker run -d -p 8080:8080 -t zaiste/jenkins</pre>

  <p>启动后，Jenkins会运行在8080端口，可通过浏览器访问。</p>
</section>

<section class="slide">
  <h2>自动化测试、代码质量检测、发布</h2>

  <p><strong>Job</strong>: Jenkins中的核心概念，表示一种抽象的任务。</p>

  <p>根据任务需要，建立如下三个job:</p>

  <ul>
    <li>tm_test: 执行测试、代码质量检测等</li>
    <li>tm_staging_deploy: 将代码部署到staging服务器上</li>
    <li>tm_production_deploy: 将代码部署到production服务器上</li>
  </ul>

  <img src="http://hustlzp-ppt.qiniudn.com/flow.png" alt=""/>
</section>

<section class="slide">
  <h2>工作流程简介</h2>

  <ol>
    <li>使用Git作为代码管理工具</li>
    <li>开发新功能时，需新建一个特性分支，开发完毕后合并到master</li>
    <li>每当master分支的代码变动时，触发tm_test任务</li>
    <li>tm_test若运行通过，则自动触发tm_staging_deploy任务，否则发送邮件报警</li>
    <li>人工登陆运行在staging服务器上的网站，检查是否达到预期效果</li>
    <li>若达到预期效果，手动触发tm_production_deploy任务</li>
    <li>人工登陆运行在production服务器上的网站，检查是否达到预期效果</li>
  </ol>
</section>

<section class="slide">
  <h2>tm_test</h2>

  <p>流程:</p>

  <img src="http://hustlzp-ppt.qiniudn.com/tm_test.png" alt=""/>
</section>

<section class="slide">
  <h2>tm_test / 触发</h2>

  <p>需要达到的效果：每当开发成员向master推送更新时，触发tm_test任务。</p>

  <p>如何实现：</p>

  <ul>
    <li>Jenkins的Git插件支持如下特性：当某url收到HTTP请求时，触发build。</li>
    <li>GitHub等支持 <strong>Webhook</strong>：当Git服务器接收到push后，向指定url发送HTTP请求。</li>
  </ul>

  <p>因此，只需要在Git服务器上配置好Webhook即可：</p>

  <img src="http://hustlzp-ppt.qiniudn.com/Snip20141002_4.png" alt=""/>

</section>

<section class="slide">
  <h2>tm_test / 准备测试环境</h2>

  <p>在tm_test中添加Execute shell项，输入：</p>

    <pre>if [ ! -d "venv" ]; then
  virtualenv -p /usr/bin/python2.7 venv
fi

. venv/bin/activate
pip install -r requirements.txt</pre>
</section>

<section class="slide">
  <h2>tm_test / 测试</h2>

  <p>在tm_test中添加Execute shell项，输入：</p>

  <pre>nosetests --with-xunit --with-coverage --cover-package=tm && coverage xml</pre>

  <ul>
    <li>使用nose测试Python程序</li>
    <li>--with-xunit告诉nose输出JUnit形式的测试报告</li>
    <li>--with-coverage表示同时计算测试覆盖率</li>
    <li>--cover-package=tm表示仅对指定的package执行测试覆盖率检测</li>
    <li>coverage xml表示输出xml格式的coverage报告</li>
  </ul>
</section>

<section class="slide">
  <h2>tm_test / 代码质量检测</h2>

  <p>使用Pylint检测Python代码质量：</p>

  <pre>pylint tm2 > pylint.xml || exit 0</pre>

  <p>使用JSHint检测JavaScript代码质量：</p>

  <pre>jshint --reporter=jslint $WORKSPACE/tm2/static/js/ > jslint.xml || exit 0</pre>
</section>

<section class="slide">
  <h2>tm_test / 检测TODO等特殊标记</h2>

  <p>写代码的时候，如果某个功能有待完善，可以加一个TODO标记，如：</p>

  <pre># TODO: need to calculate the recommend teachers
recommend_teachers = Teacher.query.limit(10)</pre>

  <p>可以借助 <strong>Task Scanner Plugin</strong> 插件，实现对特殊标记的检测：</p>

  <img src="http://hustlzp-ppt.qiniudn.com/Snip20141002_1.png" alt=""/>
</section>

<section class="slide">
  <h2>tm_test / 测试覆盖率报告</h2>

  <p>使用 <strong>Cobertura Plugin</strong> 插件来收集测试覆盖率：</p>

  <img src="http://hustlzp-ppt.qiniudn.com/coverage.png" alt=""/>

  <p>单个文件的详细报告：</p>

  <img src="http://hustlzp-ppt.qiniudn.com/Snip20140816_25.jpeg" alt=""/>
</section>

<section class="slide">
  <h2>tm_test / 代码质量检测报告</h2>

  <p>使用 <strong>Violations</strong> 插件来收集代码质量报告。</p>

  <p>支持pylint、jshint、csslint、cpplint等诸多代码检测程序。</p>

  <img src="http://hustlzp-ppt.qiniudn.com/code_check.png" alt=""/>
</section>

<section class="slide">
  <h2>tm_test / 邮件告警</h2>

  <p>Jenkins默认支持邮件告警功能。</p>

  <img style="margin-left: 0;" src="http://hustlzp-ppt.qiniudn.com/Snip20141002_2.png" alt=""/>

  <p>小技巧：将qq邮箱绑定到手机（15271872672@qq.com），即可实现短信报警通知。</p>
</section>

<section class="slide">
  <h2>tm_test / 触发下游job</h2>

  <p>使用 <strong>Parameterized Trigger Plugin</strong> 插件触发其他job。</p>

  <img style="margin-left: 0;" src="http://hustlzp-ppt.qiniudn.com/Snip20141002_3.png" alt=""/>
</section>

<section class="slide">
  <h2>tm_staging_deploy</h2>

  <p>流程：</p>

  <img src="http://hustlzp-ppt.qiniudn.com/tm_staging_deploy.png" alt=""/>

  <p>需要 <strong>SSH plugin</strong> 插件实现远程登录。</p>
</section>

<section class="slide">
  <h2>tm_staging_deploy / 部署代码示例</h2>

  <pre>cd /var/www/tm
export MODE=PRODUCTION           # 设置环境变量
git reset --hard HEAD
git pull -f                      # 更新代码
source venv/bin/activate
pip install -r requirements.txt  # 安装依赖项
python manage.py db upgrade      # 执行数据库upgrade
supervisorctl restart tm         # 重启app</pre>
</section>

<section class="slide">
  <h2>tm_production_deploy</h2>

  <p>流程：</p>

  <img src="http://hustlzp-ppt.qiniudn.com/production_deploy.png" alt=""/>
</section>

<section class="slide">
  <h2>Jenkins配置文件备份</h2>

  <p>Jenkins的配置是一项较为费时的过程。</p>

  <p>需要对Jenkins的配置文件（xml）进行备份，以便出现意外后恢复。</p>

  <p>使用 <strong>ThinBackup</strong> 插件实现备份。</p>
</section>

<section class="slide">
  <h2>Jenkins配置文件变更记录</h2>

  <p>同事A对Jenkins配置进行了更新。</p>

  <p>第二天Jenkins服务器出现错误，同事A着手解决，但是他忘记了到底对配置做了哪些更改，找了很久都没有发现错误所在。</p>

  <p><strong>启发</strong>：如果能够知道Jenkins配置文件的变更历史，对于debug有非常大的帮助。</p>

  <p>→ 使用 <strong>SCM Sync configuration plugin</strong> 插件记录Jenkins配置文件的变更历史。</p>

  <p><strong>原理</strong>：每次更新配置，都会发送一个commit提交到Git仓库。</p>

  <img src="http://hustlzp-ppt.qiniudn.com/Snip20141002_5.png" alt=""/>
</section>

<section class="slide">
  <h2>小结</h2>

  <p>关注用户体验（对外），也关注工作体验（对内）。</p>

  <p>关注DevOps = 提升产品的交付速度和质量 + 提升程序员的工作体验。</p>

  <img src="http://hustlzp-ppt.qiniudn.com/1348121383_9531.jpg" alt=""/>
</section>

<section class="slide">
  <h2>插件清单</h2>

  <ul>
    <li>Git Plugin：使用Git作为源代码管理</li>
    <li>SSH plugin：远程ssh登录server执行命令</li>
    <li>Parameterized Trigger Plugin：触发下游job</li>
    <li>Cobertura Plugin：代码测试覆盖率报告</li>
    <li>Task Scanner Plugin：检测代码中出现的特殊标记（如TODO等）</li>
    <li>Violations：代码质量检测报告</li>
    <li>ThinBackup：用于备份Jenkins</li>
    <li>SCM Sync configuration plugin：将Jenkens的配置变更同步到SCM中</li>
  </ul>
</section>

<section class="slide">
  <h2>多多指教，多多交流！</h2>

  <ul>
    <li>PPT地址: http://hustlzp.github.io/jenkins-presentation</li>
    <li>相关博文: http://hustlzp.com/post/2014/08/jenkins</li>
  </ul>
</section>

<!-- End slides. -->

<!-- Begin extension snippets. Add or remove as needed. -->

<!-- deck.navigation snippet -->
<div aria-role="navigation">
  <a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
  <a href="#" class="deck-next-link" title="Next">&#8594;</a>
</div>

<!-- deck.status snippet -->
<p class="deck-status" aria-role="status">
  <span class="deck-status-current"></span>
  /
  <span class="deck-status-total"></span>
</p>

<!-- deck.goto snippet -->
<form action="." method="get" class="goto-form">
  <label for="goto-slide">Go to slide:</label>
  <input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
  <datalist id="goto-datalist"></datalist>
  <input type="submit" value="Go">
</form>

<!-- End extension snippets. -->
</div>

<!-- Required JS files. -->
<script src="jquery.min.js"></script>
<script src="core/deck.core.js"></script>

<!-- Extension JS files. Add or remove as needed. -->
<script src="extensions/menu/deck.menu.js"></script>
<script src="extensions/goto/deck.goto.js"></script>
<script src="extensions/status/deck.status.js"></script>
<script src="extensions/navigation/deck.navigation.js"></script>
<script src="extensions/scale/deck.scale.js"></script>

<!-- Initialize the deck. You can put this in an external file if desired. -->
<script>
  $(function () {
    $.deck('.slide');
  });
</script>
</body>
</html>
